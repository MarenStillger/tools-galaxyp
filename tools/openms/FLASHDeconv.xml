<!--This is a configuration file for the integration of a tools into Galaxy (https://galaxyproject.org/). This file was automatically generated using CTDConverter.-->
<!--Proposed Tool Section: [Top-Down]-->
<tool id="FLASHDeconv" name="FLASHDeconv" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="21.05">
  <description>Ultra-fast high-quality deconvolution enables online processing of top-down MS data</description>
  <macros>
    <token name="@EXECUTABLE@">FLASHDeconv</token>
    <import>macros.xml</import>
  </macros>
  <expand macro="requirements"/>
  <expand macro="stdio"/>
  <command detect_errors="exit_code"><![CDATA[@QUOTE_FOO@
@EXT_FOO@
#import re

## Preprocessing
mkdir in &&
cp '$in' 'in/${re.sub("[^\w\-_]", "_", $in.element_identifier)}.$gxy2omsext($in.ext)' &&
mkdir out &&
#if "out_spec_FLAG" in str($OPTIONAL_OUTPUTS).split(',')
  mkdir out_spec &&
  mkdir ${' '.join(["'out_spec/%s'" % (i) for i, f in enumerate($in) if f])} && 
#end if
#if "out_mzml_FLAG" in str($OPTIONAL_OUTPUTS).split(',')
  mkdir out_mzml &&
#end if
#if "out_annotated_mzml_FLAG" in str($OPTIONAL_OUTPUTS).split(',')
  mkdir out_annotated_mzml &&
#end if
#if "out_promex_FLAG" in str($OPTIONAL_OUTPUTS).split(',')
  mkdir out_promex &&
#end if
#if "out_topFD_FLAG" in str($OPTIONAL_OUTPUTS).split(',')
  mkdir out_topFD &&
  mkdir ${' '.join(["'out_topFD/%s'" % (i) for i, f in enumerate($in) if f])} && 
#end if
#if "out_topFD_feature_FLAG" in str($OPTIONAL_OUTPUTS).split(',')
  mkdir out_topFD_feature &&
  mkdir ${' '.join(["'out_topFD_feature/%s'" % (i) for i, f in enumerate($in) if f])} && 
#end if

## Main program call

set -o pipefail &&
@EXECUTABLE@ -write_ctd ./ &&
python3 '$__tool_directory__/fill_ctd.py' '@EXECUTABLE@.ctd' '$args_json' '$hardcoded_json' &&
@EXECUTABLE@ -ini @EXECUTABLE@.ctd
-in
'in/${re.sub("[^\w\-_]", "_", $in.element_identifier)}.$gxy2omsext($in.ext)'
-out
'out/output.${gxy2omsext("tabular")}'
#if "out_spec_FLAG" in str($OPTIONAL_OUTPUTS).split(',')
  -out_spec
  ${' '.join(["'out_spec/%s/%s.%s'"%(i, re.sub('[^\w\-_]', '_', f.element_identifier), $gxy2omsext("tabular")) for i, f in enumerate($in) if f])}
#end if
#if "out_mzml_FLAG" in str($OPTIONAL_OUTPUTS).split(',')
  -out_mzml
  'out_mzml/output.${gxy2omsext("mzml")}'
#end if
#if "out_annotated_mzml_FLAG" in str($OPTIONAL_OUTPUTS).split(',')
  -out_annotated_mzml
  'out_annotated_mzml/output.${gxy2omsext("mzml")}'
#end if
#if "out_promex_FLAG" in str($OPTIONAL_OUTPUTS).split(',')
  -out_promex
  'out_promex/output.${gxy2omsext("txt")}'
#end if
#if "out_topFD_FLAG" in str($OPTIONAL_OUTPUTS).split(',')
  -out_topFD
  ${' '.join(["'out_topFD/%s/%s.%s'"%(i, re.sub('[^\w\-_]', '_', f.element_identifier), $gxy2omsext("txt")) for i, f in enumerate($in) if f])}
#end if
#if "out_topFD_feature_FLAG" in str($OPTIONAL_OUTPUTS).split(',')
  -out_topFD_feature
  ${' '.join(["'out_topFD_feature/%s/%s.%s'"%(i, re.sub('[^\w\-_]', '_', f.element_identifier), $gxy2omsext("txt")) for i, f in enumerate($in) if f])}
#end if
#if len(str($OPTIONAL_OUTPUTS).split(',')) == 0
  | tee '$stdout'
#end if

## Postprocessing
&& mv 'out/output.${gxy2omsext("tabular")}' '$out'
#if "out_spec_FLAG" in str($OPTIONAL_OUTPUTS).split(',')
  ${' '.join(["&& mv -n 'out_spec/%(bn)s/%(id)s.%(gext)s' 'out_spec/%(bn)s/%(id)s'"%{"bn": i, "id": re.sub('[^\w\-_]', '_', f.element_identifier), "gext": $gxy2omsext("tabular")} for i, f in enumerate($in) if f])}
#end if
#if "out_mzml_FLAG" in str($OPTIONAL_OUTPUTS).split(',')
  && mv 'out_mzml/output.${gxy2omsext("mzml")}' '$out_mzml'
#end if
#if "out_annotated_mzml_FLAG" in str($OPTIONAL_OUTPUTS).split(',')
  && mv 'out_annotated_mzml/output.${gxy2omsext("mzml")}' '$out_annotated_mzml'
#end if
#if "out_promex_FLAG" in str($OPTIONAL_OUTPUTS).split(',')
  && mv 'out_promex/output.${gxy2omsext("txt")}' '$out_promex'
#end if
#if "out_topFD_FLAG" in str($OPTIONAL_OUTPUTS).split(',')
  ${' '.join(["&& mv -n 'out_topFD/%(bn)s/%(id)s.%(gext)s' 'out_topFD/%(bn)s/%(id)s'"%{"bn": i, "id": re.sub('[^\w\-_]', '_', f.element_identifier), "gext": $gxy2omsext("txt")} for i, f in enumerate($in) if f])}
#end if
#if "out_topFD_feature_FLAG" in str($OPTIONAL_OUTPUTS).split(',')
  ${' '.join(["&& mv -n 'out_topFD_feature/%(bn)s/%(id)s.%(gext)s' 'out_topFD_feature/%(bn)s/%(id)s'"%{"bn": i, "id": re.sub('[^\w\-_]', '_', f.element_identifier), "gext": $gxy2omsext("txt")} for i, f in enumerate($in) if f])}
#end if
#if "ctd_out_FLAG" in $OPTIONAL_OUTPUTS
  && mv '@EXECUTABLE@.ctd' '$ctd_out'
#end if]]></command>
  <configfiles>
    <inputs name="args_json" data_style="paths"/>
    <configfile name="hardcoded_json"><![CDATA[{"log": "log.txt", "threads": "\${GALAXY_SLOTS:-1}", "no_progress": true}]]></configfile>
  </configfiles>
  <inputs>
    <param argument="-in" type="data" format="mzml" optional="false" label="Input file (mzML)" help=" select mzml data sets(s)"/>
    <param argument="-min_precursor_snr" type="float" optional="false" value="1.0" label="Minimum precursor SNR (SNR within the precursor envelope range) for identification" help="Similar to precursor interference level, but far more stringent as it also considers the isotope distribution shape of signal.When FLASHIda log file is used, this parameter is ignored. Applied only for topFD msalign outputs"/>
    <param argument="-target_precursor_charge" type="integer" optional="false" value="0" label="Charge state of the target precurso" help="All precursor charge is fixed to this value. This parameter is useful for targeted studies where MS2 spectra are generated from a fixed precursor (e.g., Native-MS). This option also gives the maximum charge and masses (together with precursor m/z) of fragment ions, which overrides -Algorithm:max_charge and -Algorithm:max_mass"/>
    <param argument="-target_precursor_mz" type="float" optional="false" value="0.0" label="Target precursor m/z value" help="This option must be used with -target_precursor_charge option. Otherwise it will be ignored. If -target_precursor_charge option is used but this option is not used, the precursor m/z value written in MS2 spectra will be used by default. Together with -target_precursor_charge, this option overrides -Algorithm:max_mass"/>
    <param argument="-mzml_mass_charge" type="integer" optional="false" min="-1" max="1" value="0" label="Charge state of deconvolved masses in mzml output (specified by out_mzml)" help=""/>
    <param argument="-preceding_MS1_count" type="integer" optional="false" min="1" value="3" label="Specifies the number of preceding MS1 spectra for MS2 precursor determination" help="In TDP, the precursor peak of a MS2 spectrum may not belong to any deconvolved masses in the MS1 spectrum immediately preceding the MS2 spectrum. Increasing this parameter to N allows for the search for the deconvolved masses in the N preceding MS1 spectra from the MS2 spectrum, increasing the chance that its precursor is deconvolved"/>
    <param argument="-write_detail" type="integer" optional="false" min="0" max="1" value="0" label="To write peak information per deconvolved mass in detail or not in tsv files for deconvolved spectra" help="If set to 1, all peak information (m/z, intensity, charge and isotope index) per mass is reported"/>
    <param argument="-merging_method" type="integer" optional="false" min="0" max="2" value="0" label="Method for spectra merging before deconvolution" help="0: No merging 1: Average gaussian method to perform moving gaussian averaging of spectra per MS level. Effective to increase proteoform ID sensitivity (in particular for Q-TOF datasets). 2: Block method to perform merging of all spectra into a single one per MS level (e.g., for NativeMS datasets)"/>
    <param argument="-report_FDR" type="integer" optional="false" min="0" max="1" value="0" label="Report qvalues (roughly, point-wise FDR) for deconvolved masses in the tsv files for deconvolved spectra" help="Dummy masses to calculate qvalues and FDR are also reported. Beta version"/>
    <section name="Algorithm" title="" help="" expanded="false">
      <param name="tol" argument="-Algorithm:tol" type="text" optional="false" value="10.0 10.0 10.0" label="ppm tolerance for MS1, MS2, ..." help=" (space separated list, in order to allow for spaces in list items surround them by single quotes)">
        <expand macro="list_float_valsan" name="tol"/>
      </param>
      <param name="min_mass" argument="-Algorithm:min_mass" type="float" optional="false" value="50.0" label="Minimum mass (Da)" help=""/>
      <param name="max_mass" argument="-Algorithm:max_mass" type="float" optional="false" value="100000.0" label="Maximum mass (Da)" help=""/>
      <param name="min_charge" argument="-Algorithm:min_charge" type="integer" optional="false" value="1" label="Minimum charge state for MS1 spectra (can be negative for negative mode)" help=""/>
      <param name="max_charge" argument="-Algorithm:max_charge" type="integer" optional="false" value="100" label="Maximum charge state for MS1 spectra (can be negative for negative mode)" help=""/>
      <param name="min_mz" argument="-Algorithm:min_mz" type="float" optional="false" value="-1.0" label="If set to positive value, minimum m/z to deconvolve" help=""/>
      <param name="max_mz" argument="-Algorithm:max_mz" type="float" optional="false" value="-1.0" label="If set to positive value, maximum m/z to deconvolve" help=""/>
      <param name="min_rt" argument="-Algorithm:min_rt" type="float" optional="false" value="-1.0" label="If set to positive value, minimum RT to deconvolve" help=""/>
      <param name="max_rt" argument="-Algorithm:max_rt" type="float" optional="false" value="-1.0" label="If set to positive value, maximum RT to deconvolve" help=""/>
      <param name="isolation_window" argument="-Algorithm:isolation_window" type="float" optional="false" value="5.0" label="Default isolation window with" help="If the input mzML file does not contain isolation window width information, this width will be used"/>
      <param name="min_isotope_cosine" argument="-Algorithm:min_isotope_cosine" type="text" optional="false" value="0.85 0.85 0.85" label="Cosine similarity thresholds between avg" help="and observed isotope patterns for MS1, 2, ... (e.g., -min_isotope_cosine 0.8 0.6 to specify 0.8 and 0.6 for MS1 and MS2, respectively) (space separated list, in order to allow for spaces in list items surround them by single quotes)">
        <expand macro="list_float_valsan" name="min_isotope_cosine"/>
      </param>
      <param name="allowed_isotope_error" argument="-Algorithm:allowed_isotope_error" type="integer" optional="false" value="1" label="Allowed isotope index error for decoy and qvalue report" help="If it is set to 1, for example, +-1 isotope errors are not counted as false. Beta version"/>
      <param name="min_intensity" argument="-Algorithm:min_intensity" type="float" optional="false" value="0.0" label="Intensity threshold" help=""/>
    </section>
    <section name="FeatureTracing" title="" help="" expanded="false">
      <param name="mass_error_ppm" argument="-FeatureTracing:mass_error_ppm" type="float" optional="false" value="-1.0" label="Feature tracing mass ppm tolerance" help="When negative, MS1 tolerance for mass deconvolution will be used (e.g., 16 ppm is used when -Algorithm:tol 16)"/>
      <param name="quant_method" argument="-FeatureTracing:quant_method" type="select" optional="false" display="radio" label="Method of quantification for mass traces" help="For LC data 'area' is recommended, 'median' for direct injection data. 'max_height' simply uses the most intense peak in the trace">
        <option value="area" selected="true">area</option>
        <option value="median">median</option>
        <option value="max_height">max_height</option>
        <expand macro="list_string_san" name="quant_method"/>
      </param>
      <param name="min_sample_rate" argument="-FeatureTracing:min_sample_rate" type="float" optional="false" value="0.05" label="Minimum fraction of scans along the feature trace that must contain a peak" help="To raise feature detection sensitivity, lower this value close to 0"/>
      <param name="min_trace_length" argument="-FeatureTracing:min_trace_length" type="float" optional="false" value="10.0" label="Minimum expected length of a mass trace (in seconds)" help=""/>
      <param name="max_trace_length" argument="-FeatureTracing:max_trace_length" type="float" optional="false" value="-1.0" label="Maximum expected length of a mass trace (in seconds)" help="Set to a negative value to disable maximal length check during mass trace detection"/>
      <param name="min_isotope_cosine" argument="-FeatureTracing:min_isotope_cosine" type="float" optional="false" value="-1.0" label="Cosine similarity threshold between avg" help="and observed isotope pattern for mass features. if not set, controlled by -Algorithm:min_isotope_cosine_ option"/>
    </section>
    <expand macro="adv_opts_macro">
      <param argument="-in_log" type="text" optional="true" value="" label="log file generated by FLASHIda (IDA*.log)" help="Only needed for coupling with FLASHIda acquisition">
        <expand macro="list_string_san" name="in_log"/>
      </param>
      <param argument="-max_MS_level" type="integer" optional="false" min="1" value="3" label="Maximum MS level (inclusive) for deconvolution" help=""/>
      <param argument="-forced_MS_level" type="integer" optional="false" min="0" value="0" label="If set to an integer N, MS level of all spectra will be set to N regardless of original MS level" help="Useful when deconvolving datasets containing only MS2 spectra"/>
      <param argument="-use_RNA_averagine" type="integer" optional="false" min="0" max="1" value="0" label="If set to 1, RNA averagine model is used" help=""/>
      <param argument="-force" type="boolean" truevalue="true" falsevalue="false" checked="false" label="Overrides tool-specific checks" help=""/>
      <param argument="-test" type="hidden" optional="true" value="False" label="Enables the test mode (needed for internal use only)" help="">
        <expand macro="list_string_san" name="test"/>
      </param>
    </expand>
    <param name="OPTIONAL_OUTPUTS" type="select" optional="true" multiple="true" label="Optional outputs">
      <option value="out_spec_FLAG">out_spec (Output tsv files containing deconvolved spectra (per MS level))</option>
      <option value="out_mzml_FLAG">out_mzml (Output mzml file containing deconvolved spectra (of all MS levels))</option>
      <option value="out_annotated_mzml_FLAG">out_annotated_mzml (Output mzml file containing annotated spectra)</option>
      <option value="out_promex_FLAG">out_promex (Output ms1ft (promex compatible) file containing deconvolved spectra)</option>
      <option value="out_topFD_FLAG">out_topFD (Output msalign (topFD compatible) files containing deconvolved spectra (per MS level))</option>
      <option value="out_topFD_feature_FLAG">out_topFD_feature (Output feature (topFD compatible) files containing deconvolved features (per MS level))</option>
      <option value="ctd_out_FLAG">Output used ctd (ini) configuration file</option>
    </param>
  </inputs>
  <outputs>
    <data name="out" label="${tool.name} on ${on_string}: out" format="tabular"/>
    <collection type="list" name="out_spec" label="${tool.name} on ${on_string}: out_spec">
      <discover_datasets directory="out_spec" recurse="true" format="tabular" pattern="__name__"/>
      <filter>OPTIONAL_OUTPUTS is not None and "out_spec_FLAG" in OPTIONAL_OUTPUTS</filter>
    </collection>
    <data name="out_mzml" label="${tool.name} on ${on_string}: out_mzml" format="mzml">
      <filter>OPTIONAL_OUTPUTS is not None and "out_mzml_FLAG" in OPTIONAL_OUTPUTS</filter>
    </data>
    <data name="out_annotated_mzml" label="${tool.name} on ${on_string}: out_annotated_mzml" format="mzml">
      <filter>OPTIONAL_OUTPUTS is not None and "out_annotated_mzml_FLAG" in OPTIONAL_OUTPUTS</filter>
    </data>
    <data name="out_promex" label="${tool.name} on ${on_string}: out_promex" format="txt">
      <filter>OPTIONAL_OUTPUTS is not None and "out_promex_FLAG" in OPTIONAL_OUTPUTS</filter>
    </data>
    <collection type="list" name="out_topFD" label="${tool.name} on ${on_string}: out_topFD">
      <discover_datasets directory="out_topFD" recurse="true" format="txt" pattern="__name__"/>
      <filter>OPTIONAL_OUTPUTS is not None and "out_topFD_FLAG" in OPTIONAL_OUTPUTS</filter>
    </collection>
    <collection type="list" name="out_topFD_feature" label="${tool.name} on ${on_string}: out_topFD_feature">
      <discover_datasets directory="out_topFD_feature" recurse="true" format="txt" pattern="__name__"/>
      <filter>OPTIONAL_OUTPUTS is not None and "out_topFD_feature_FLAG" in OPTIONAL_OUTPUTS</filter>
    </collection>
    <data name="ctd_out" format="xml" label="${tool.name} on ${on_string}: ctd">
      <filter>OPTIONAL_OUTPUTS is not None and "ctd_out_FLAG" in OPTIONAL_OUTPUTS</filter>
    </data>
  </outputs>
  <tests>
    <!-- TOPP_FLASHDeconv_1 -->
    <test expect_num_outputs="5">
      <section name="adv_opts">
        <param name="in_log" value=""/>
        <param name="max_MS_level" value="3"/>
        <param name="forced_MS_level" value="0"/>
        <param name="use_RNA_averagine" value="0"/>
        <param name="force" value="false"/>
        <param name="test" value="true"/>
      </section>
      <param name="in" value="FLASHDeconv_sample_input.mzML"/>
      <output name="out" value="FLASHDeconv_1.tmp" compare="sim_size" delta_frac="0.7" ftype="tabular"/>
      <output_collection name="out_spec" count="1"/>
      <output_collection name="out_topFD" count="1"/>
      <output_collection name="out_topFD_feature" count="1"/>
      <param name="min_precursor_snr" value="1.0"/>
      <param name="target_precursor_charge" value="0"/>
      <param name="target_precursor_mz" value="0.0"/>
      <param name="mzml_mass_charge" value="0"/>
      <param name="preceding_MS1_count" value="3"/>
      <param name="write_detail" value="0"/>
      <param name="merging_method" value="0"/>
      <param name="report_FDR" value="0"/>
      <section name="Algorithm">
        <param name="tol" value="10.0 10.0 10.0"/>
        <param name="min_mass" value="50.0"/>
        <param name="max_mass" value="100000.0"/>
        <param name="min_charge" value="1"/>
        <param name="max_charge" value="100"/>
        <param name="min_mz" value="-1.0"/>
        <param name="max_mz" value="-1.0"/>
        <param name="min_rt" value="-1.0"/>
        <param name="max_rt" value="-1.0"/>
        <param name="isolation_window" value="5.0"/>
        <param name="min_isotope_cosine" value="0.85 0.85 0.85"/>
        <param name="allowed_isotope_error" value="1"/>
        <param name="min_intensity" value="0.0"/>
      </section>
      <section name="FeatureTracing">
        <param name="mass_error_ppm" value="-1.0"/>
        <param name="quant_method" value="area"/>
        <param name="min_sample_rate" value="0.05"/>
        <param name="min_trace_length" value="10.0"/>
        <param name="max_trace_length" value="-1.0"/>
        <param name="min_isotope_cosine" value="-1.0"/>
      </section>
      <param name="OPTIONAL_OUTPUTS" value="ctd_out_FLAG,out_spec_FLAG,out_topFD_FLAG,out_topFD_feature_FLAG"/>
      <output name="ctd_out" ftype="xml">
        <assert_contents>
          <is_valid_xml/>
        </assert_contents>
      </output>
      <assert_stdout>
        <has_text_matching expression="@EXECUTABLE@ took .* \(wall\), .* \(CPU\), .* \(system\), .* \(user\)(; Peak Memory Usage: 32 MB)?."/>
      </assert_stdout>
    </test>
  </tests>
  <help><![CDATA[Ultra-fast high-quality deconvolution enables online processing of top-down MS data


For more information, visit https://openms.de/doxygen/release/3.1.0/html/TOPP_FLASHDeconv.html]]></help>
  <expand macro="references"/>
</tool>
